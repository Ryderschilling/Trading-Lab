// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id            String   @id @default(cuid())
  clerkId       String   @unique
  email         String   @unique
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  trades            Trade[]
  dailyPerformance  DailyPerformance[]
  monthlyPerformance MonthlyPerformance[]
  aggregatedStats   AggregatedStats[]
  goals             Goal[]
  journalEntries    JournalEntry[]
  aiConversations   AIConversationHistory[]
  rawCsvRows        RawCSVRow[]
  brokerExecutions  BrokerExecution[]

  @@map("users")
}

model Trade {
  id              String   @id @default(cuid())
  userId          String
  tradeDate       DateTime @db.Date
  ticker          String
  assetType       String // Stock, Call, Put
  entryPrice      Float
  exitPrice       Float?
  quantity        Int
  contracts       Int? // For options
  totalInvested   Float
  totalReturn     Float
  percentReturn   Float
  notes           String?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  user            User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  optionMetadata  OptionMetadata?
  rawCsvRow       RawCSVRow?

  @@index([userId, tradeDate])
  @@index([userId, ticker])
  @@index([userId, assetType])
  @@map("trades")
}

model OptionMetadata {
  id              String   @id @default(cuid())
  tradeId         String   @unique
  expirationDate  DateTime? @db.Date
  strikePrice     Float?
  dayOfWeek       String? // Monday, Tuesday, etc.
  is0DTE          Boolean  @default(false)
  isWeekly        Boolean  @default(false)
  isMonthly       Boolean  @default(false)

  trade           Trade    @relation(fields: [tradeId], references: [id], onDelete: Cascade)

  @@map("option_metadata")
}

model DailyPerformance {
  id              String   @id @default(cuid())
  userId          String
  date            DateTime @db.Date
  netPnl          Float    @default(0)
  tradeCount      Int      @default(0)
  winCount        Int      @default(0)
  lossCount       Int      @default(0)
  totalVolume     Float    @default(0)
  avgWin          Float?
  avgLoss          Float?
  largestWin      Float?
  largestLoss      Float?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, date])
  @@index([userId, date])
  @@map("daily_performance")
}

model MonthlyPerformance {
  id              String   @id @default(cuid())
  userId          String
  year            Int
  month           Int // 1-12
  netPnl          Float    @default(0)
  tradeCount      Int      @default(0)
  winCount        Int      @default(0)
  lossCount       Int      @default(0)
  greenDays       Int      @default(0)
  redDays         Int      @default(0)
  bestDay         Float?
  worstDay        Float?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, year, month])
  @@index([userId, year, month])
  @@map("monthly_performance")
}

model AggregatedStats {
  id                String   @id @default(cuid())
  userId            String   @unique
  totalPnl          Float    @default(0)
  totalTrades       Int      @default(0)
  winRate           Float    @default(0)
  avgWin            Float    @default(0)
  avgLoss           Float    @default(0)
  avgTradePnl       Float    @default(0) // Average Trade P/L
  profitFactor      Float    @default(0)
  bestTicker        String?
  worstTicker       String?
  largestWin        Float?
  largestLoss       Float?
  callsPnl          Float    @default(0)
  putsPnl           Float    @default(0)
  stocksPnl         Float    @default(0)
  zeroDTEPnl        Float    @default(0)
  weeklyPnl         Float    @default(0)
  monthlyPnl        Float    @default(0)
  mondayPnl         Float    @default(0)
  tuesdayPnl        Float    @default(0)
  wednesdayPnl      Float    @default(0)
  thursdayPnl       Float    @default(0)
  fridayPnl         Float    @default(0)
  lastUpdated       DateTime @default(now())
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  user              User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("aggregated_stats")
}

model Goal {
  id              String   @id @default(cuid())
  userId          String
  name            String
  type            String // monthly_profit, max_daily_loss, max_trades_per_day, win_rate, consistency, max_size, max_contracts
  targetValue     Float
  timeframe       String // daily, weekly, monthly
  currentValue    Float   @default(0)
  isActive        Boolean @default(true)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, isActive])
  @@map("goals")
}

model JournalEntry {
  id              String   @id @default(cuid())
  userId          String
  date            DateTime @db.Date
  
  // Nutrition & Stimulants
  breakfast       String? // Skipped / Light / Balanced / Heavy
  caffeine        String? // None / 1 serving / 2–3 servings / 4+ servings
  sugar           String? // None / Some / High
  hydration       String? // Low / Moderate / Well hydrated
  
  // Sleep & Recovery
  sleepDuration   String? // <5h / 5–6h / 6–7h / 7–8h / 8+h
  sleepQuality    String? // Poor / Okay / Great
  bedtime         String? // Before 10pm / 10–12 / After 12
  wakeFeeling     String? // Tired / Neutral / Energized
  
  // Trading Behavior
  tradingQuality  String? // Disciplined / Average / Sloppy
  revengeTrading  String? // Yes / No
  distractions    String? // None / Minor / Frequent
  overtrading     String? // Yes / No
  timeSpentTrading String? // <30 min / 30–60 min / 1–2 hrs / 2+ hrs
  stoppedWhenShouldHave String? // Yes / No
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, date])
  @@index([userId, date])
  @@map("journal_entries")
}


model AIConversationHistory {
  id              String   @id @default(cuid())
  userId          String
  role            String // user, assistant
  content         String
  createdAt       DateTime @default(now())

  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, createdAt])
  @@map("ai_conversation_history")
}

model RawCSVRow {
  id              String   @id @default(cuid())
  userId          String
  tradeId         String?  @unique
  rowData         String   // JSON string of original CSV row
  uploadedAt      DateTime @default(now())
  createdAt       DateTime @default(now())

  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  trade           Trade?   @relation(fields: [tradeId], references: [id], onDelete: SetNull)

  @@index([userId, uploadedAt])
  @@map("raw_csv_rows")
}

model BrokerExecution {
  id                String   @id @default(cuid())
  userId            String
  uploadId          String 
  broker            String   // "robinhood", "tdameritrade", etc.
  activityDate      DateTime @db.Date
  instrument        String
  description       String?
  transactionType   String   // "BTO", "STC", "STO", "BTC", "BUY", "SELL"
  quantity          Float    // Allow fractional quantities
  price             Float
  amount            Float    // Net amount (can be negative)
  rawRowData        String?  // JSON string of original CSV row for reference
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  user              User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, activityDate])
  @@index([userId, broker])
  @@index([userId, instrument])
  @@index([userId, transactionType])
  @@map("broker_executions")
}

